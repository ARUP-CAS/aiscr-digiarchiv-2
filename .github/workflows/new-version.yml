name: New version

on:
  workflow_dispatch:
    inputs:
      new_tag:
        description: 'Tag name following "vx.x.x" semantics (e.g. "v1.0.0"):'
        type: string
        required: true
      citation_update:
        description: 'Update citation'
        type: boolean
        required: true
        default: true
   
concurrency:
  group: release-${{ github.repository }}
  cancel-in-progress: false

jobs:
  update_files:
    name: Update citation
    permissions:
      id-token: write
      contents: write
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.final-sha.outputs.sha }}
    steps:
      - name: Validate tag format
        run: |
          set -euo pipefail
          if [[ ! "${{ inputs.new_tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format. Must be vX.Y.Z"
            exit 1
          fi
      
      - name: Log-in as AMCR app
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.AISCR_AMCR_ACTIONS_APP_ID }}
          private-key: ${{ secrets.AISCR_AMCR_ACTIONS_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Install yq
        if: ${{ inputs.citation_update }}
        uses: mikefarah/yq@v4

      - name: Update CITATION.cff
        if: ${{ inputs.citation_update }}
        run: |
          set -euo pipefail
          if [ ! -f CITATION.cff ]; then
            echo "CITATION.cff not found"
            exit 1
          fi
          VERSION=${{ inputs.new_tag }}
          DATE=$(date -I)
          yq -i '.version = "'"$VERSION"'"' CITATION.cff
          yq -i '.date-released = "'"$DATE"'"' CITATION.cff
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add CITATION.cff
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update CITATION.cff for release $VERSION"
            git pull --rebase origin main
            git push --force-with-lease || {
              echo "Push failed due to upstream changes. Retry release."
              exit 1
            }
          fi

      - name: Set final SHA
        id: final-sha
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
  
  new_version:
    name: Create new tag
    needs: update_files
    permissions:
      contents: write
      deployments: write
    runs-on: ubuntu-latest
    steps:
      - name: Log-in as AMCR app
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.AISCR_AMCR_ACTIONS_APP_ID }}
          private-key: ${{ secrets.AISCR_AMCR_ACTIONS_KEY }}
      
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: main
          fetch-depth: 0

      - name: Check if tag exists
        run: |
          git fetch --tags --force
          if git show-ref --tags --verify --quiet "refs/tags/${{ inputs.new_tag }}"; then
            echo "Tag already exists!"
            exit 1
          fi
      
      - name: Create annotated tag
        uses: rickstaa/action-create-tag@v1
        id: tag_create
        with:
          tag: ${{ inputs.new_tag }}
          commit_sha: ${{ needs.update_files.outputs.sha }}
          message: "Release ${{ inputs.new_tag }}"
          annotated: true
