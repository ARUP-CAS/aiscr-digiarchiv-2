<mat-card class="app-card-result" [class.app-card-child]="isChild()" [class.app-entity-projekt]="!isChild() && !isDocumentDialogOpen()">
  @if (mapDetail() && !isChild()) {
    <a (click)="service.setMapResult(null, true)" class="app-link-close" [matTooltip]="'card.tooltip.Zavřít' | translate">
      <mat-icon>clear</mat-icon>
    </a>
  }
  <mat-card-header>
    <mat-card-title class="app-fxLayout app-row app-center-v app-gap-4">
      <div class="app-fxFlex" (click)="service.showInMap(_result, false, false, isChild())">
        @if (!state.isMapaCollapsed && !isChild() && !mapDetail()) {
          <a class="app-icon-info"><mat-icon>info</mat-icon></a>
        }
        <mat-icon class="app-entity-projekt" [matTooltip]="'entities.projekt.title' | translate">{{ config.entityIcons["projekt"] }}</mat-icon>
        @if (isChild()) {
          <a [routerLink]="'/id/' + _result.ident_cely" [queryParams]="{lang: state.currentLang}" target="_blank" class="app-ident-badge" [matTooltip]="'card.tooltip.Persistentní odkaz' | translate">{{ _result.ident_cely }} <mat-icon>link</mat-icon></a>
        }
        @if (!isChild()) {
          <span class="app-ident-format">{{ _result.ident_cely }}</span>
        }
        <span class="app-pipe"></span>
        @if (_result.projekt_hlavni_katastr) {
          <app-inline-filter [isChild]="isChild()" [field]="'f_katastr'" [value]="_result.projekt_hlavni_katastr"></app-inline-filter>
        }
        <span class="app-element-wrapper app-ml-1">(<app-inline-filter [isChild]="isChild()" [field]="'f_okres'" [value]="_result.projekt_okres"></app-inline-filter>)</span>
        <span class="app-pipe"></span><app-inline-filter [isChild]="isChild()" [field]="'f_vedouci'" [value]="_result.projekt_vedouci_projektu" ></app-inline-filter><span class="app-pipe"></span>
          @if (!state.isMapaCollapsed) {
            <label>{{ _result.projekt_datum_zahajeni | date : 'dd.MM.yyyy'}} - {{ _result.projekt_datum_ukonceni | date : 'dd.MM.yyyy' }}</label><span class="app-pipe"></span>
          }
      </div>
      @if (state.isMapaCollapsed && !isChild() || mapDetail()) {
        <div class="app-last-change" [matTooltip]="_result.datestamp | date : 'yyyy-MM-dd HH:mm:ss'">{{ 'card.desc.Poslední změna' | translate }}: {{ _result.datestamp | date : 'yyyy-MM-dd' }}</div>
      }
    </mat-card-title>
  </mat-card-header>

  <mat-card-content [class.app-detail-closed]="!_detailExpanded">
    @if (state.itemView === 'col' && !isDocumentDialogOpen() && !isChild()) {
      <div class="app-thumb app-fxLayout app-row app-fill app-center-v app-center-h" [matTooltip]="'Obrázek není k dispozici' | translate">
        <mat-icon>image_not_supported</mat-icon>
      </div>
    }
    <div class="app-metadata app-mb-4">
      @if (_result.projekt_typ_projektu || _result.projekt_datum_zahajeni) {
        <div>
          @if (_result.projekt_typ_projektu) {
            <label class="app-label">{{ 'card.desc.Projekt - typ' | translate }}:</label>&#160;
            <app-inline-filter [isChild]="isChild()" [field]="'f_typ_projektu'" [value]="_result.projekt_typ_projektu" [heslar]="'typ_projektu'"></app-inline-filter>
            <span class="app-pipe"></span>
          }
          @if (_result.projekt_datum_zahajeni) {
            <label class="app-label">{{ 'card.desc.Datum provedení' | translate }}:</label>&#160;
            {{ _result.projekt_datum_zahajeni | date : 'dd.MM.yyyy'}} - {{ _result.projekt_datum_ukonceni | date : 'dd.MM.yyyy' }}<span class="app-pipe"></span>
          }
          @if (_result.pristupnost) {
            <label class="app-label">{{ 'card.desc.Přístupnost' | translate }}:</label>&#160;
            <app-inline-filter [isChild]="isChild()" [field]="'pristupnost'" [value]="_result.pristupnost" [heslar]="'pristupnost'"></app-inline-filter>
          }
        </div>
      }
      @if (_result.projekt_organizace) {
        <div>
          <label class="app-label">{{ 'card.desc.Organizace' | translate }}:</label>&#160;
          <app-inline-filter [isChild]="isChild()" [field]="'f_organizace'" [value]="_result.projekt_organizace" [heslar]="'organizace'"></app-inline-filter>
        </div>
      }
      @if (_result.projekt_chranene_udaje?.dalsi_katastr?.length > 0) {
        <div>
          <label class="app-label">{{ 'card.desc.Další katastry' | translate }}:</label>&#160;
          @for (k of _result.projekt_chranene_udaje.dalsi_katastr; track k; let last = $last) {
            <app-inline-filter [isChild]="isChild()" [field]="'f_katastr'" [value]="k.value"></app-inline-filter>
            @if (!last) {
              <span>;&#160;</span>
            }
          }
          (@for (k of _result.projekt_chranene_udaje.okresy; track k; let last = $last) {
          <app-inline-filter [isChild]="isChild()" [field]="'f_okres'" [value]="k"></app-inline-filter>
          @if (!last) {
            <span>;&#160;</span>
          }
          })
        </div>
      }
      @if (_result.projekt_podnet) {
        <div>
          <label class="app-label">{{ 'card.desc.Projekt - podnět' | translate }}:</label>&#160;
          {{ _result.projekt_podnet }}
        </div>
      }
    </div>
  </mat-card-content>

  @if (!isChild()) {
    <mat-card-actions class="app-fxLayout app-row app-end-v">
      <div class="app-fxFlex app-metadata">
        @if (relationsChecked && _result.projekt_dokument?.length > 0) {
          {{ 'card.desc.Počet dokumentů' | translate }}: <strong>{{_result.projekt_dokument?.length}}</strong>
          <span class="app-pipe"></span>
        }
        @if (relationsChecked && _result.projekt_archeologicky_zaznam?.length > 0) {
          {{ 'card.desc.Počet archeologickych zaznamu' | translate }}: <strong>{{_result.projekt_archeologicky_zaznam?.length}}</strong>
          <span class="app-pipe"></span>
        }
        @if (relationsChecked && _result.projekt_samostatny_nalez?.length > 0) {
          {{'card.desc.Počet samostatných nálezů' | translate}}: <strong>{{_result.projekt_samostatny_nalez?.length}}</strong>
          <span class="app-pipe"></span>
        }
      </div>
      <app-result-actions [inDocument]="inDocument()" [result]="_result" [bibTex]="bibTex" [isDocumentDialogOpen]="isDocumentDialogOpen()"
      [detailExpanded]="_detailExpanded" [mapDetail]="mapDetail()" (onToggleDetail)="toggleDetail()"></app-result-actions>
    </mat-card-actions>
  }

  @if (_detailExpanded && !isChild()) {
    <mat-card-content >
      <div class="app-card-detail">
        <mat-accordion multi="true">
          <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header [expandedHeight]="config.uiVars['panelHeightInCard']" [collapsedHeight]="config.uiVars['panelHeightInCard']">
              <mat-panel-title>
                {{ 'card.panelTitle.Popis projektu' | translate }}:
              </mat-panel-title>
            </mat-expansion-panel-header>
            <table>
              <tbody>
                @if (_result.projekt_chranene_udaje?.lokalizace) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Akce - lokalizace' | translate }}:</th>
                    <td>{{ _result.projekt_chranene_udaje?.lokalizace }}</td>
                  </tr>
                }
                @if (_result.projekt_podnet) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Projekt - podnět' | translate }}:</th>
                    <td>{{ _result.projekt_podnet }}</td>
                  </tr>
                }
                @if (_result.projekt_chranene_udaje?.parcelni_cislo) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Parcelní číslo' | translate }}:</th>
                    <td>{{ _result.projekt_chranene_udaje?.parcelni_cislo }}</td>
                  </tr>
                }
                @if (_result.projekt_planovane_zahajeni) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Plánované zahájení' | translate }}:</th>
                    <td>{{ formatDate(_result.projekt_planovane_zahajeni) }}</td>
                  </tr>
                }
                @if (_result.projekt_uzivatelske_oznaceni) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Uživatelské označení' | translate }}:</th>
                    <td>{{ _result.projekt_uzivatelske_oznaceni | translate }}</td>
                  </tr>
                }
                @if (_result.projekt_kulturni_pamatka) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Památková ochrana' | translate }}:</th>
                    <td>{{ _result.projekt_kulturni_pamatka | translate }}</td>
                  </tr>
                }
                @if (_result.projekt_chranene_udaje?.kulturni_pamatka_cislo) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Rejstříkové číslo ÚSKP' | translate }}:</th>
                    <td>{{ _result.projekt_chranene_udaje.kulturni_pamatka_cislo }}</td>
                  </tr>
                }
                @if (_result.projekt_chranene_udaje?.kulturni_pamatka_popis) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Název památky' | translate }}:</th>
                    <td>{{ _result.projekt_chranene_udaje.kulturni_pamatka_popis }}</td>
                  </tr>
                }
                @if (_result.projekt_oznaceni_stavby) {
                  <tr>
                    <th class="app-label">{{ 'card.desc.Projekt - oznaceni_stavby' | translate }}:</th>
                    <td>{{ _result.projekt_oznaceni_stavby }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </mat-expansion-panel>
          <app-related [related]="related()" [mapDetail]="mapDetail()"></app-related>
        </mat-accordion>
      </div>
    </mat-card-content>
  }
</mat-card>
